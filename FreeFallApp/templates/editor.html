{% extends 'base.html' %}
{% block content %}
{% load static %}

<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.css' rel='stylesheet' />
<link href="{% static 'css/editor.css' %}" rel='stylesheet' />

<script src="http://www.openlayers.org/api/OpenLayers.js"></script>

<script src="{% static 'js/editor.js' %}"></script>
<script src="{% static 'js/my_account.js' %}"></script>
<link href="{% static 'libs/modules/cropper/cropper.css' %}" rel="stylesheet">


<form method="POST" enctype="multipart/form-data">
    {%csrf_token%}

    <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="basic_parameters_nav" data-toggle="tab" href="#basic_parameters_content"
                role="tab" aria-controls="basic_parameters_content" aria-selected="true">Базовые параметры</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="profile-tab" data-toggle="tab" href="#participants_content" role="tab"
                aria-controls="participants_content" aria-selected="false">Участники</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="contact-tab" data-toggle="tab" href="#map_content" role="tab"
                aria-controls="map_content" aria-selected="false">Карта</a>
        </li>
    </ul>
    <!-- <hr class="active_tab_line" style=""> -->
    <div class="tab-content" id="myTabContent">
        <!-- БАЗОВЫЕ ПАРАМЕТЫ -->
        <div class="tab-pane fade show active" id="basic_parameters_content" role="tabpanel" aria-labelledby="home-tab">
            <!--БЛОК БАЗОВЫХ ПАРАМЕТРОВ-->
            <br>
            <div class="col-md" id="custom-file-input">
                <input type="file" class="file-upload" name="image" style="display: none;" id="myfile"
                    accept=".jpg, .jpeg, .png">
            </div>

            <div class="col" style="padding-right: 0px;">
                <div class="row">
                    <div class="col">
                        <div class="row avt">
                            {% if image == '' %}
                            <img src="{% static 'icons/default.jpg' %}" id="myimg" class="avatar"
                                default="Фото не выбрано"></img>
                            {% else %}
                            <img src="{{ image.url }}" id="myimg" class="avatar" default="Фото не выбрано"
                                style="height: auto;"></img>
                            {% endif %}
                        </div>
                        <div class="photo_edit_menu">
                            <label id='upload_label' type="button" for="myfile"><i class="fas fa-plus"></i></label>
                            <i class="far fa-trash-alt"></i>
                        </div>
                        <!-- <div class="row" style="padding: 0px; margin: 0px;">
                            <div class="col-sm" id="custom-file-input" style="padding: 0px;width: 350px;">
                                <label type="button" for="myfile" class="upload-btn"
                                    style="display: block;text-align: center;width: 100%;">Загрузить
                                </label>
                            </div>
                            <div class="col-sm" id="del_button" style="padding: 0px;">




                            </div>
                        </div> -->
                        <script src="{% static 'js/upload_photo.js' %}"></script>
                        
                    </div>

                                {% if image.name != '' %}
                                <script>
                                    del_without_replacing();
                                </script>
                                {% endif %}






                    <div class="col">

                        <div class="row">
                            <div class="col">
                            <label for="exampleFormControlInput1">Название похода</label>
                        </div>
                        </div>
                        <div class="row"><div class="col">
                            <input type="text" class="form-control" name="name" placeholder=" " style="font-size: 18px;"
                                value="{{name}}"></div>
                        </div>

                        <div class="row"><div class="col">
                            <label for="">Краткое описание</label></div>
                        </div>
                        <div class="row"><div class="col">
                            <textarea id="sh_desc" class="form-control" name="short_description"
                                placeholder="Несколько строк о походе" style="font-size: 14px; height: 140px;">{{short_description}}
                            </textarea></div>
                        </div>
                    </div>


                    <!-- Полное имя и описание -->

                </div>
            </div>
            <!--END-->
            <div class="row" id="hidden_fields" style="display: none;">
                <input type="hidden" name="landmarks" id="lm_list">
            </div>




            <div class="col">

                <div class="row" style="width: 60%;">

                    <div class="col-sm">
                        <div class="row">
                            <label for="">Дата начала похода</label>
                        </div>
                        <div class="row">
                            <input type="date" name="start" class="form-control" value={{start_date}}>
                        </div>
                    </div>
                    <div class="col-sm-1">
                        <div class="row">
                            <p></p>
                        </div>
                        <div class="row">
                            <p style="vertical-align: middle;text-align: center;"> </p>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="row">
                            <label for="">Дата окончания похода</label>
                        </div>
                        <div class="row">
                            <input type="date" name="end" class="form-control" value={{end_date}}>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label for="">Сложность</label><br>

                    <button type="button" onclick="select_difficulty('none')" value="none"
                        class='btn btn-outline-secondary hike_diff_btns'>Без категории</button>
                    <button type="button" onclick="select_difficulty('I')" value="I"
                        class='btn btn-outline-secondary hike_diff_btns'>I</button>
                    <button type="button" onclick="select_difficulty('II')" value="II"
                        class='btn btn-outline-secondary hike_diff_btns'>II</button>
                    <button type="button" onclick="select_difficulty('III')" value="III"
                        class='btn btn-outline-secondary hike_diff_btns'>III</button>
                    <button type="button" onclick="select_difficulty('IV')" value="IV"
                        class='btn btn-outline-secondary hike_diff_btns'>IV</button>
                    <button type="button" onclick="select_difficulty('V')" value="V"
                        class='btn btn-outline-secondary hike_diff_btns'>V</button>
                    <button type="button" onclick="select_difficulty('VI')" value="VI"
                        class='btn btn-outline-secondary hike_diff_btns'>VI</button>


                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label for="">Тип</label><br>
                    <button type="button" onclick="select_type('Пеший')" value="Пеший" id="wlk_type"
                        class='btn btn-outline-secondary hike_type_btns'>Пеший</button>
                    <button type="button" onclick="select_type('Горный')" value="Горный" id="mnt_type"
                        class='btn btn-outline-secondary hike_type_btns'>Горный</button>
                    <button type="button" onclick="select_type('Водный')" value="Водный" id="wtr_type"
                        class='btn btn-outline-secondary hike_type_btns'>Водный</button>
                    <button type="button" onclick="select_type('Вело')" value="Вело" id="bck_type"
                        class='btn btn-outline-secondary hike_type_btns'>Вело</button>
                    <button type="button" onclick="select_type('Спелео')" value="Спелео" id="cv_type"
                        class='btn btn-outline-secondary hike_type_btns'>Спелео</button>
                </div>
            </div>
            <script>
                function select_type(type) {
                    byId('set_type').value = type;
                    // alert(byId('set_type').value);
                    Object.values(document.getElementsByClassName('hike_type_btns')).forEach(btn => {
                        if (btn.value == type) {
                            btn.className = 'btn btn-outline-secondary hike_type_btns indigo outline';
                        }
                        else {
                            btn.className = 'btn btn-outline-secondary hike_type_btns';
                        }
                    })
                }
                function select_difficulty(type) {
                    byId('set_difficulty').value = type;
                    // alert(byId('set_type').value);
                    Object.values(document.getElementsByClassName('hike_diff_btns')).forEach(btn => {
                        if (btn.value == type) {
                            btn.className = 'btn btn-outline-secondary hike_diff_btns indigo outline';
                        }
                        else {
                            btn.className = 'btn btn-outline-secondary hike_diff_btns';
                        }
                    })
                }
            </script>


            <input type="hidden" name='type' id='set_type'>
            <input type="hidden" name='difficulty' id='set_difficulty'>

            <script>
                document.getElementById("sh_desc").value = `{{short_description}}`;
                select_difficulty("{{difficulty}}");
                select_type("{{type_of_hike}}");
            </script>
            <script src="{% static 'libs/modules/ckeditor/ckeditor.js' %}"></script>



            <label for="exampleFormControlInput1">Подробное описание</label>
            <div class="card-body" style="padding:0px;padding-bottom:5px;padding-left: 0px;padding-right: 0px;">

                <textarea id="editor" name="description">
                    {{description|safe}}
                </textarea>
                <div id="toolbar-container" class="edtor" style="width: 90px;"></div>
                <script>
                    ClassicEditor
                        .create(document.querySelector('#editor'))
                        .then(editor => {
                            console.log(editor);
                        })
                        .catch(error => {
                            console.error(error);
                        });
                </script>
            </div>
            <br>
            <div class='row'>
                <div class='col'>
                    <a href="/editor" class="btn btn-outline-secondary btn-block btn-lg indigo outline">Отменить
                        изменения</a></div>
                <div class='col'><input type="submit" class="btn btn-secondary btn-block btn-lg indigo"
                        value="Сохранить изменения">
                </div>
            </div>
            <!--КОНЕЦ БЛОКА БАЗОВЫХ ПАРАМЕТРОВ-->
        </div>

        <script src="{% static 'libs/modules/cropper/cropper.min.js' %}"></script>
        <script src="{% static 'js/cropper.js' %}"></script>
        <script src="{% static 'js/new_hike.js' %}"></script>


        <div class="modal" tabindex="-1" role="dialog" aria-labelledby="Cropper_photo" id="Cropper_photo">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Modal title</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>Modal body text goes here.</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary">Save changes</button>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>















        <link href="{% static 'libs/modules/bootstrap-select/css/bootstrap-select.min.css'%}" rel="stylesheet">

        <!-- УЧАСТНИКИ -->
        <div class="tab-pane show fade" id="participants_content" role="tabpanel"
            aria-labelledby="participants_content">
            <label for="">Максимальное количество участников</label><br>
            <input type="number" class='btn btn-outline-secondary' value={{limit_of_members}} id="limit_of_members"
                name="limit_of_members" min="1" max="1000">
            <br>


            <label for="">Как пользователи могут присоединиться к группе</label><br>
            <div class="custom-control custom-radio custom-control-inline">
                <input type="radio" class="custom-control-input" id="open" name="can_users_join" value="open">
                <label class="custom-control-label" for="open" style="font-weight: 300;">Свободное добавление</label>
            </div>

            <div class="custom-control custom-radio custom-control-inline">
                <input type="radio" class="custom-control-input" id="request" name="can_users_join" value="request"
                    checked>
                <label class="custom-control-label" for="request" style="font-weight: 300;">По запросу</label>
            </div>

            <div class="custom-control custom-radio custom-control-inline">
                <input type="radio" class="custom-control-input" id="close" name="can_users_join" value="close">
                <label class="custom-control-label" for="close" style="font-weight: 300;">Только по приглашению</label>
            </div>
            <br><br>
            <script>
                byId('{{join_to_group}}').checked = 'checked';
            </script>
            <input type="submit" class="btn btn-outline-secondary btn-block" value="Сохранить эти настройки">
            <br>
            <h2 style="text-align: center;">Добавление участников</h2>
            <select class="selectpicker" data-live-search="true" id="select_ptc">
                {% for user in user_list %}
                <option data-tokens="{{user.0}}" value="{{user.0}}">{{user.1}}</option>
                {% endfor %}

            </select>
            <button class="btn btn-outline-secondary" type="button" onclick="add_user()">Добавить</button>
            <input type="hidden" id='hike_id' value="{{hike_id}}">
            <div class="row">



                <div class="col-sm">
                    <label>Приглашённые пользователи</label>
                </div>
                <div class="col-sm" style="">
                    <label>Вступившие пользователи</label>
                </div>

            </div>

            <div class="row">
                <div class="col-sm" style="overflow-y: scroll; min-height: 300px; width: 70%;">
                    <div class="card" id="potential_ptc">
                        {% for user in potential_ptc %}
                        <div class="card" id='user_{{user.2}}'
                            style="border: 1px solid rgb(224, 224, 224);border-radius:0px;margin-bottom: 4px;">
                            <div class="row" style="padding: 5px;">
                                <input type='hidden' class="user_hidden_id" value='{{user.3}}'>
                                <div class="col-sm-2" style="vertical-align: middle;">
                                    {% if user.1 != '' %}
                                    <img src="{{user.1.url}}" style="width: 60px; height: 60px;">
                                    {% else %}
                                    <img src="{% static 'icons/logo_grey.png' %}" style="width: 60px;height: 60px;">
                                    {% endif %}
                                </div>
                                <div class="col-sm" style="vertical-align: bottom;height: 60px;">
                                    <p style="padding-top:0.7em; letter-spacing: 0.084em;">{{user.0}}</p>
                                    <p style="color: gray;line-height: 0em;">@{{user.2}}</p>
                                </div>
                                <div class="col-sm-3" style="height: 60px;vertical-align: bottom">
                                    <button type="button" onclick="del_pot_user('{{user.2}}','{{user.3}}')"
                                        class="btn btn-light" style="height: 60px;width: 100%;">Удалить</button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-sm" style="overflow-y: scroll; min-height: 300px;width: 70%;max-height: 300px;">
                    <div class="card" id="potential_ptc">
                        {% for user in participants %}
                        <div class="card" id='user_{{user.2}}'
                            style="border: 1px solid rgb(224, 224, 224);border-radius:0px;margin-bottom: 4px;">
                            <div class="row" style="padding: 5px;">
                                <input type='hidden' class="user_hidden_id" value='{{user.3}}'>
                                <div class="col-sm-2" style="vertical-align: middle;">
                                    {% if user.1 != '' %}
                                    <img src="{{user.1.url}}" style="width: 60px; height: 60px;">
                                    {% else %}
                                    <img src="{% static 'icons/logo_grey.png' %}" style="width: 60px;height: 60px;">
                                    {% endif %}
                                </div>
                                <div class="col-sm" style="vertical-align: bottom;height: 60px;">
                                    <p style="padding-top:0.7em; letter-spacing: 0.084em;">{{user.0}}</p>
                                    <p style="color: gray;line-height: 0em;">@{{user.2}}</p>
                                </div>
                                {% if user.2 != username %}
                                <div class="col-sm-3" style="height: 60px;vertical-align: bottom">
                                    <button type="button" onclick="del_pot_user('{{user.2}}','{{user.3}}')"
                                        class="btn btn-light" style="height: 60px;width: 100%;">Удалить</button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>


            </div>

        </div>

        <!-- DO NOT EDIT BLOCK -->
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>

        <script src="{% static 'libs/modules/bootstrap/js/bootstrap.min.js' %}"></script>

        <script src="{% static 'libs/modules/bootstrap-select/js/bootstrap-select.min.js' %}"></script>

        <script src="{% static 'libs/modules/jquery/jquery.js' %}" type="text/javascript"></script>

        <script src="{% static '/libs/modules/bootstrap/js/bootstrap.js' %}"></script>
        <!-- END OF DO-NOT-EDIT BLOCK -->


        <script>
            async function add_user() {

                if (byId("user_" + byId('select_ptc').value) == undefined) {
                    add_ptc();
                }
                else {
                    card = byId("user_" + byId('select_ptc').value);

                    async function demo() {

                        // console.log(6);
                        byId("user_" + byId('select_ptc').value).className = "red-border";
                        await sleep(700);
                        // console.log(7);
                        byId("user_" + byId('select_ptc').value).className = "";
                    }

                    demo();
                }

            }
            function add_ptc() {
                // list = str_to_list(document.getElementById('list-usrs').value);
                user = document.getElementById('select_ptc').value;
                hike_id = byId('hike_id').value;
                //СЮДЫТЬ ВСТАВИТЬ AJAX-ЗАПРОС
                $.ajax({
                    url: "/does_user_exist/",
                    type: 'POST',
                    data: { 'username': user, 'add_to_hike': true, 'hike_id': hike_id },
                    beforeSend: function (xhr, settings) {
                        function getCookie(name) {
                            var cookieValue = null;
                            if (document.cookie && document.cookie != '') {
                                var cookies = document.cookie.split(';');
                                for (var i = 0; i < cookies.length; i++) {
                                    var cookie = jQuery.trim(cookies[i]);
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }
                        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                            // Only send the token to relative URLs i.e. locally.
                            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                        }
                    },
                    success: function a(json) {
                        // alert(json);
                        // alert(json.exist);
                        if (json.exist === "True") {
                            var user_exists = true;
                            // list.push(user);
                            // document.getElementById('list-usrs').value = list;
                            // alert(document.getElementById('list-usrs').value);

                            user_card = document.createElement("li");

                            user_card.className = "card";
                            user_card.style = "border: 1px solid rgb(224, 224, 224);border-radius:0px;margin-bottom: 4px;";
                            user_card.id = 'user_' + user;


                            id_field = document.createElement('input')
                            id_field.type = 'hidden';
                            id_field.value = json.id;
                            id_field.className = "user_hidden_id"




                            byId('potential_ptc').appendChild(user_card);

                            row = document.createElement('div');
                            row.className = 'row';
                            row.style = "padding: 5px;";
                            user_card.appendChild(row);
                            row.appendChild(id_field);

                            col2 = document.createElement('div');
                            col2.className = "col-sm-2";
                            col2.style = "vertical-align: middle;";
                            row.appendChild(col2)

                            img = document.createElement("img");
                            img.style = "width: 60px;height:60px";
                            if (json.exist_image) {
                                data = json.image
                                img.src = 'data:image/gif;base64,' + data;
                            }
                            else {
                                img.src = "{%static 'icons/logo_grey.png'%}";
                            }
                            col2.appendChild(img);

                            col1 = document.createElement('div');
                            col1.className = "col-sm";
                            col1.style = "vertical-align: bottom;height: 60px;";
                            row.appendChild(col1);

                            p = document.createElement('p');
                            p.style = "padding-top:0.7em; letter-spacing: 0.084em;";
                            p.innerHTML = json.full_name;

                            col1.appendChild(p)

                            p_username = document.createElement('p');
                            p_username.style = "color: gray;line-height: 0em;";
                            p_username.innerHTML = '@' + user;
                            col1.appendChild(p_username);

                            col3 = document.createElement('div');
                            col3.className = "col-sm-3";
                            col3.style = "height: 60px;vertical-align: bottom";
                            row.appendChild(col3);

                            button = document.createElement('button');
                            button.type = 'button';
                            button.className = "btn btn-light";
                            button.style = "height: 60px;width: 100%;";
                            button.innerHTML = 'Удалить';

                            button.onclick = function () {
                                del_pot_user(this.parentNode.parentNode.childNodes[2].childNodes[1].innerHTML.replace("@", ""),
                                    this.parentNode.parentNode.childNodes[0].value
                                )
                            }
                            col3.appendChild(button);

                        }

                    }

                });






            }
            function delete_avatar() {
                document.getElementById("myimg").src = "{% static 'icons/default.jpg' %}";
                clearInputFile(document.getElementById("myfile"));
                del_avatar_button();
            }                
        </script>
        <!-- КАРТА -->
        <div class="tab-pane fade" id="map_content" role="tabpanel" aria-labelledby="map-tab">

            <script
                src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
            <link rel="stylesheet"
                href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css"
                type="text/css" />


            <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
            <script src="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js"></script>
            <link href="https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css" rel="stylesheet" />

            <div id="osm_map" style="width:auto;height:500px">
                <!-- БЛОК "СОЗДАТЬ ДОСТОПРИМЕЧАТЕЛЬНОСТЬ" -->
                <div class="map-overlay-container" id="new_landmark" style="display: none;">
                    <div class="map-overlay">

                        <button type="button" class="btn btn-outline-secondary" style="float: right;"
                            onclick="change_mode()">x</button>
                        <h2>Создать достопримечательность</h2>


                        <label for="exampleFormControlInput1">Название</label>
                        <input type="text" class="form-control" name="lm_name" placeholder=" " style="font-size: 18px;"
                            value="" id="lm_name">


                        <label for="public_switcher">Описание</label>

                        <textarea id="lm_desc" class="form-control" name="lm_desc" placeholder=""
                            style="font-size: 14px; height: 140px;"></textarea>



                        <div class="custom-control custom-switch">
                            <input type="checkbox" name="is_public" class="custom-control-input" id="lm_is_public"
                                checked>
                            <label class="custom-control-label" for="lm_is_public">Видна для всех</label>
                        </div>
                    </div>
                </div>
                <!-- КОНЕЦ БЛОКА "СОЗДАТЬ ДОСТОПРИМЕЧАТЕЛЬНОСТЬ" -->
                <!---->
                <div class="map-overlay-container" id="del_lmk" style="display: none;">
                    <div class="map-overlay">

                        <button type="button" class="btn btn-outline-secondary" style="float: right;"
                            onclick="byId('del_lmk').style='display: none;'">x</button>
                        <h2>Удаление достопримечательности </h2>
                        <h2 id='lmk_name'></h2>
                        <p id="lmk_desc"></p>
                        <p id="lmk_id" style="display: none;"></p>

                        <label for="exampleFormControlInput1">Вы уверены, что хотите удалить эту
                            достопримечательность?</label>
                        <button type='button' class="btn btn-outline-danger" onclick="del_lmk()">Удалить</button>
                        <button type='button' class="btn btn-outline-secondary"
                            onclick="byId('del_lmk').style='display: none;'">Отмена</button>

                    </div>
                </div>


                <!---->
            </div>

            <script>

                mapboxgl.accessToken = 'pk.eyJ1IjoiY2FzeTciLCJhIjoiY2s1aWl5MXV4MGI5dDNvbW41bm82OGpmdyJ9.t3Er5THaXs9H0hH2JSp-Ww';
                var osm_map = new mapboxgl.Map({
                    container: 'osm_map',
                    style: 'mapbox://styles/casy7/ck8delv4d0zgm1io4178mjhbn',
                    center: [3.420253241560829, 46.124064037019906],
                    zoom: 13
                });
                // osm_map.resize()
                var customData = {
                    features: [

                    ],
                    type: "FeatureCollection"
                };

                function resize() {
                    i = 0
                    try {
                        osm_map.resize();
                        i++;
                        console.log('map was resized');
                    }
                    catch (e) {
                        i++;
                        console.log('error with_resizing');
                    }


                }
                // resize();
                function forwardGeocoder(query) {
                    var matchingFeatures = [];
                    for (var i = 0; i < customData.features.length; i++) {
                        var feature = customData.features[i];
                        // handle queries with different capitalization than the source data by calling toLowerCase()
                        if (
                            feature.properties.title.toLowerCase().search(query.toLowerCase()) !== -1
                        ) {
                            // add a tree emoji as a prefix for custom data results
                            // using carmen geojson format: https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
                            feature["place_name"] = "🌲 " + feature.properties.title;
                            feature["center"] = feature.geometry.coordinates;
                            feature["place_type"] = ["park"];
                            matchingFeatures.push(feature);
                        }
                    }
                    return matchingFeatures;
                }
                osm_map.addControl(
                    new MapboxGeocoder({
                        accessToken: mapboxgl.accessToken,
                        localGeocoder: forwardGeocoder,
                        zoom: 14,
                        placeholder: "Введите адрес",
                        mapboxgl: mapboxgl
                    })
                );


                // osm_map.addControl(new mapboxgl.NavigationControl());
                // osm_map.update();

                coordinates = eval('{{ coordinates | safe }}');
                var elements = [];
                var markers = [];
                for (i = 0; i < coordinates.length; i++) {
                    var el = document.createElement('div');
                    el.id = 'marker' + i.toString();
                    el.content = coordinates[i][0];
                    el.textContent = coordinates[i][0];
                    el.className = 'marker';
                    el.style.backgroundImage = "url({% static 'icons/marker.png' %})";
                    el.x = coordinates[i][1][0];
                    el.y = coordinates[i][1][1];
                    var id = el.id;
                    var marker = new mapboxgl.Marker(el, { draggable: true }).setLngLat([el.x, el.y]).addTo(osm_map);

                    elements.push({
                        element: el,
                        marker: marker
                    });

                    markers.push({
                        day: coordinates[i][0],
                        marker: marker,
                        id: id,
                    })


                }

                elements.forEach(function (item, index) {
                    var el = item.element;
                    var marker = item.marker;
                    item.element.addEventListener('contextmenu', function () {
                        cord_del.push(el.id);
                        document.getElementById("del_coords").value = cord_del;
                        marker.remove();
                    });
                });

            </script>


            Выберите день:
            <select id="day" , value="1" class="form-control" style="width: 20%;display: inline-block;">
                {% for day in days %}
                <option value="{{day.id}}" id="{{day.name}}">{{day.name}}</option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-outline-secondary" style="float: right;"
                class="btn btn-outline-secondary" onclick="change_mode()">Создать
                достопримечательность</button>
            <div class="card" id="days_list">

                {% for day in days %}

                <div class="day_card" id="{{day.label}}_card">
                    <h3>{{day.name}}</h3>
                    <label>Заголовок дня</label>
                    <input type="text" class="form-control" name="{{day.label}}_caption" placeholder="Заголовок дня"
                        value='{{day.caption}}'>
                    <label>Описание дня</label>
                    <textarea class="form-control" name="{{day.label}}_description" placeholder="Описание дня"
                        style="font-size: 13px;">{{day.description}}</textarea>
                </div>

                {% endfor %}






            </div>

            <script>

                //osm_map.resize()
                if (eval('{{ coordinates | safe }}') != []) {
                    var coordinates = eval('{{ coordinates | safe  }}');
                }
                else {
                    var coordinates = []
                }
                var was_click = false
                var landmarks = [];
                var landmarks_mode = false;
                var icon = "url({% static 'icons/marker.png' %})";
                var icon_m = "url({% static 'icons/marker.png' %})";
                var icon_l = "url({% static 'icons/mountain.png' %})";

                function change_mode() {
                    if (landmarks_mode) {
                        landmarks_mode = false;
                        icon = icon_m;
                        byId("new_landmark").style.display = "none";
                    }
                    else {
                        icon = icon_l;
                        byId('del_lmk').style.display = 'none'
                        byId("new_landmark").style.display = "block";
                        landmarks_mode = true;
                    }
                }

                osm_map.on('load', function () {
                    //osm_map.resize()
                    cord_del = []

                    // byId("new_landmark").style.display = "block";

                    was_click = false
                    osm_map.on('click', function (e) {
                        byId('del_lmk').style.display = 'none'

                        if (landmarks_mode) {
                            coords = e.lngLat.toArray();
                            id = 1;
                            while (osm_map.getLayer('lk_' + id) != undefined) {
                                id += 1;
                            }
                            if (byId("lm_name").value != "") {

                                // Создание достопримечательности
                                osm_map.addLayer({
                                    id: "lk_" + id,
                                    type: "symbol",
                                    source: {
                                        type: "geojson",
                                        data: {
                                            type: "FeatureCollection",
                                            features: [

                                                {
                                                    type: "Feature",
                                                    properties: {
                                                        description:
                                                            `<p style='display:none'>` + id + `</p><strong>` + byId("lm_name").value + `</strong><p>` + byId("lm_desc").value + `</p>`,
                                                        icon: "mountain"
                                                    },
                                                    geometry: {
                                                        type: "Point",
                                                        coordinates: coords
                                                    }
                                                },


                                            ]
                                        }
                                    },
                                    layout: {
                                        "icon-image": "{icon}-15",
                                        "icon-allow-overlap": true
                                    }
                                });
                                osm_map.on("click", "lk_" + id, function (e) {

                                    var coordinates = e.features[0].geometry.coordinates.slice();
                                    var description = e.features[0].properties.description;

                                    // Ensure that if the map is zoomed out such that multiple
                                    // copies of the feature are visible, the popup appears
                                    // over the copy being pointed to.
                                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                                    }
                                    new mapboxgl.Popup()
                                        .setLngLat(coordinates)
                                        .setHTML(description)
                                        .addTo(osm_map);
                                });
                                name = byId("lm_name").value;
                                desc = byId("lm_desc").value;
                                add_lmk(id, name, desc, coords);
                                change_mode();
                            }
                            else {
                                alert("Пожалуйста, сначала введите название достопримечательности")
                            }
                        }
                        else {
                            var day = (document.getElementById("day").value)
                            var el = document.createElement('div');
                            el.id = 'marker' + markers.length.toString();
                            el.content = day;
                            el.className = 'marker';
                            was_click = true
                            el.textContent = day;
                            el.style.backgroundImage = icon;
                            coordinates.push(Array(Number(day), e.lngLat.toArray()));
                            document.getElementById("coords").value = coordinates;
                            var id = el.id;


                            var marker = new mapboxgl.Marker(el, { draggable: true })
                                .setLngLat(e.lngLat.wrap())
                                .addTo(osm_map);

                            markers.push({
                                id: id,
                                day: Number(day),
                                marker: marker
                            })

                            el.addEventListener('contextmenu', function () {
                                cord_del.push(el.id);
                                document.getElementById("del_coords").value = cord_del;
                                marker.remove();

                            });
                        }

                    });

                    osm_map.on('render', function (t) {
                        osm_map.resize();
                        // resize();
                    });

                    // ДОСТОПРИМЕЧАТЕЛЬНОСТИ
                    // {% for lk in landmarks %}
                    osm_map.addLayer({
                        id: "lk_{{lk.id}}",
                        type: "symbol",
                        source: {
                            type: "geojson",
                            data: {
                                type: "FeatureCollection",
                                features: [

                                    {
                                        type: "Feature",
                                        properties: {
                                            description:
                                                `<p style='display:none'>{{lk.id}}</p><strong>{{lk.name}}</strong><p>{{lk.description}}</p>`,
                                            icon: "mountain"
                                        },
                                        geometry: {
                                            type: "Point",
                                            coordinates: ["{{ lk.longitude }}", "{{ lk.latitude }}"]
                                        }
                                    },


                                ]
                            }
                        },
                        layout: {
                            "icon-image": "{icon}-15",
                            "icon-allow-overlap": true
                        }
                    });
                    osm_map.on("contextmenu", "lk_{{lk.id}}", function (e) {

                        desc = e.features[0].properties.description;

                        lk = e.features[0].properties;
                        id = desc.slice(desc.indexOf('>') + 1, desc.indexOf('</p>'));
                        // alert(id);
                        byId('lmk_name').innerHTML = desc.slice(desc.indexOf('<strong>') + 8, desc.indexOf('</strong>'));
                        byId('lmk_desc').innerHTML = desc.slice(desc.lastIndexOf('<p>') + 4, desc.lastIndexOf('</p>'));
                        byId('lmk_id').innerHTML = id;
                        byId('new_landmark').style.display = 'none';
                        byId('del_lmk').style.display = 'block';

                    });
                    osm_map.on("click", "lk_{{lk.id}}", function (e) {

                        var coordinates = e.features[0].geometry.coordinates.slice();
                        var description = e.features[0].properties.description;

                        // Ensure that if the map is zoomed out such that multiple
                        // copies of the feature are visible, the popup appears
                        // over the copy being pointed to.
                        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                        }
                        new mapboxgl.Popup()
                            .setLngLat(coordinates)
                            .setHTML(description)
                            .addTo(osm_map);
                    });
                    // {% endfor %}






                    // Change the cursor to a pointer when the mouse is over the places layer.
                    osm_map.on("mouseenter", "places", function () {
                        osm_map.getCanvas().style.cursor = "pointer";
                    });

                    // Change it back to a pointer when it leaves.
                    osm_map.on("mouseleave", "places", function () {
                        osm_map.getCanvas().style.cursor = "";
                    });

                });

                function save_info() {

                    coordinates = []

                    markers.forEach(function (item, index) {
                        var day = item.day;
                        var lngLat = item.marker.getLngLat();
                        var lng = lngLat.lng;
                        var lat = lngLat.lat;
                        var id = item.id;

                        coordinates.push(id, day, lng, lat)

                    });
                    debugger;
                    document.getElementById("coords").value = coordinates;
                    document.getElementById("del_coords").value = cord_del;
                }

            </script>

            <input name="coordinates" id="coords" type="hidden">
            <input name="cord_del" id="del_coords" type="hidden">
            <input name="days_info" id="days_info" type="hidden">
            <input type="submit" class="btn btn-secondary btn-block" onclick="save_info()" value="Сохранить"
                style="display: inline-block">



            <!--END OF CODE -->
        </div>
    </div>

</form>

<script src="{% static '/js/editor.js' %}" type="text/javascript"></script>

{% endblock %}